<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Flowdock Omni Search</title>
		<script type="text/javascript">
			function renderResults(resultsArray) {
				var renderArray = [];
				for (var resultIndex in resultsArray) {
					var resultObject = resultsArray[resultIndex];
					var messageUrl = `https://www.flowdock.com/app/${resultObject.orgId}/${resultObject.flowId}/threads/${resultObject.threadId}`;
					var messageText = resultObject.text.replace(resultObject.highlight, '<b>$&</b>');
					var messageTitle = resultObject.thread.replace(resultObject.highlight, '<b>$&</b>');
					// <a href="${messageUrl}" target="_blank">
					renderArray.push(`<tr><td>${resultObject.flow}</td><td>${messageTitle}</td><td>${messageText}</td></tr>`)
				}
				document.getElementById('results').innerHTML = `<table>${renderArray.join('')}</table>`;
			}

			function renderStage(stageText) {
				document.getElementById('stage').innerText = stageText;
			}

			function processForm() {
				renderStage('Submitted.');
				var username = document.getElementById('user').value;
				var password = document.getElementById('pass').value;
				var query = document.getElementById('query').value;
				var queryRegex = new RegExp(query.split(/\s+/g).join('|'), 'gi');
				var authString = username ? username + ':' + password : password;
				var requestFlows = new XMLHttpRequest();
				requestFlows.open("GET", "https://api.flowdock.com/flows/");
				requestFlows.setRequestHeader("Accept", "application/json");
				requestFlows.setRequestHeader("Content-Type", "application/json");
				requestFlows.setRequestHeader("Authorization", `Basic ${btoa(authString)}`);
				requestFlows.addEventListener("load", function() {
					renderStage('Received flow list.');
					var resultsArray = [];
					// Remember that `this` is bound onto the XHR.
					var flowsArray = JSON.parse(this.responseText);
					for (var flowIndex in flowsArray) {
						var flowObject = flowsArray[flowIndex];
						var requestMessages = new XMLHttpRequest();
						requestMessages.open("GET", `https://api.flowdock.com/flows/${flowObject.organization.parameterized_name}/${flowObject.parameterized_name}/messages/?search=${encodeURI(query)}`);
						requestMessages.setRequestHeader("Accept", "application/json");
						requestMessages.setRequestHeader("Content-Type", "application/json");
						requestMessages.setRequestHeader("Authorization", `Basic ${btoa(authString)}`);
						// Remember that `this` is bound onto the XHR.
						requestMessages.addEventListener("load", function(flowObject, queryRegex) {
							renderStage('Receiving search results.');
							var messagesArray = JSON.parse(this.responseText);
							for (var messageIndex in messagesArray) {
								var messageObject = messagesArray[messageIndex];
								if (typeof(messageObject.content) === 'string') {
									resultsArray.push({
										flow: flowObject.name,
										thread: messageObject.thread.title,
										text: messageObject.content,
										timestamp: messageObject.sent,
										orgId: flowObject.organization.parameterized_name,
										flowId: flowObject.parameterized_name,
										threadId: messageObject.thread_id,
										highlight: queryRegex,
										raw: messageObject
									});
								}
							}
							renderResults(resultsArray.sort(function(a, b) {
								return b.timestamp - a.timestamp;
							}));
						}.bind(requestMessages, flowObject, queryRegex));
						requestMessages.send();
					}
				});
				requestFlows.send();
			}
		</script>
	</head>
	<body>
		<div id="stage"><a href="https://flowdock.com/account/tokens" target="_blank">Get a token!</a></div>
		<div><form onsubmit="processForm(); return false;">
			<input type="text" id="user" placeholder="username (or blank)" />
			<input type="password" id="pass" placeholder="password (or token)" />
			<input type="text" id="query" placeholder="search term" />
			<input type="submit" value="search!" />
		</form></div>
		<div id="results"></div>
	</body>
</html>
